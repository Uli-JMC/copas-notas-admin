<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <title>Admin | Entre Copas &amp; Notas</title>
  <meta name="description" content="Panel de administración para eventos e inscripciones." />
  <link rel="stylesheet" href="./css/admin.css" />
</head>

<body class="adminPage" data-page="admin">
  <div class="toasts" id="toasts" aria-live="polite" aria-relevant="additions"></div>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="container">
      <div class="nav">
        <a class="brand" href="./index.html" aria-label="Ir al sitio público">
          <img id="adminLogo" src="./assets/img/logocuadrado-entrecopasynotas.png" alt="Logo" />
          <span>Admin · Entre Copas &amp; Notas</span>
        </a>

        <div class="navRight">
          <a class="btn" href="https://entrecopasynotas.com">Ver sitio</a>
          <button class="btn" id="logoutBtn" type="button">Salir</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="page">
    <div class="container">

      <section class="app" id="appPanel">

        <!-- HEADER / SEARCH -->
        <div class="head">
          <div>
            <p class="kicker">Gestión</p>
            <h2 class="h2">Panel de administración</h2>
            <p class="sub">Eventos, fechas, cupos, inscripciones y recursos visuales.</p>
          </div>

          <div class="headActions">
            <input
              class="search"
              id="search"
              type="search"
              placeholder="Buscar evento o inscripción…"
              aria-label="Buscar"
              autocomplete="off"
            />
          </div>
        </div>

        <!-- =====================================================
             SIDEBAR LAYOUT WRAP
        ====================================================== -->
        <div class="adminLayout">

          <!-- SIDEBAR (tabs) -->
          <aside class="adminSide" aria-label="Navegación">
            <div class="sideCard">

              <div class="sideTitle">
                <div class="sideKicker">Secciones</div>
                <div class="sideHint">Elegí una vista</div>
              </div>

              <!-- TABS: mantenemos .tabs y .tab para que tu JS siga igual -->
              <div class="tabs sideTabs" role="tablist" aria-label="Secciones">
                <button class="tab" data-tab="events" aria-selected="true" type="button">Eventos</button>
                <button class="tab" data-tab="dates" aria-selected="false" type="button">Fechas</button>
                <button class="tab" data-tab="regs" aria-selected="false" type="button">Inscripciones</button>
                <button class="tab" data-tab="media" aria-selected="false" type="button">Medios</button>
                <button class="tab" data-tab="gallery" aria-selected="false" type="button">Galería</button>
                <button class="tab" data-tab="promos" aria-selected="false" type="button">Promos</button>
              </div>

              <div class="sideFooter">
                <div class="sideChip">Tip</div>
                <div class="sideFootText">Usá el buscador arriba para filtrar rápido.</div>
              </div>
            </div>
          </aside>

          <!-- CONTENT (paneles) -->
          <div class="adminContent">

            <!-- =====================================================
                 EVENTS
            ====================================================== -->
            <section class="panel" id="tab-events" role="tabpanel">
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Eventos</h3>
                    <div class="mini">Crear, editar y publicar eventos.</div>
                  </div>

                  <div class="listHead">
                    <div class="pill">Lista</div>
                    <div class="actions">
                      <button class="btn btn--ghost" id="newEventBtn" type="button">Nuevo</button>
                      <button class="btn btn--ghost" id="dupEventBtn" type="button">Duplicar</button>
                    </div>
                  </div>

                  <!-- ✅ Compat: algunos scripts antiguos preguntan por #eventsList -->
                  <div id="eventsList" hidden></div>

                  <div class="list" id="eventList" aria-label="Lista de eventos">
                    <!-- JS -->
                  </div>

                  <div class="empty" id="eventsEmpty" hidden>
                    Aún no hay eventos. Creá el primero con “Nuevo”.
                  </div>

                  <div class="note" id="storageNote" aria-live="polite"></div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Editor</h3>
                    <div class="mini">Completá la info del evento y guardá cambios.</div>
                  </div>

                  <div class="empty" id="editorEmpty">
                    Seleccioná un evento de la lista para editarlo.
                  </div>

                  <!-- ✅ Compat: scripts antiguos -->
                  <input id="eventTitle" type="hidden" value="" />
                  <input id="eventType" type="hidden" value="" />
                  <input id="eventMonthKey" type="hidden" value="" />

                  <form class="form" id="eventForm" autocomplete="off" hidden>
                    <input type="hidden" id="eventId" />

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evTitle">Título</label>
                        <input class="input" id="evTitle" type="text" required maxlength="80" />
                      </div>
                      <div class="field">
                        <label class="label" for="evType">Tipo</label>
                        <select class="select" id="evType" required>
                          <option value="Cata de vino">Vino / Cata</option>
                          <option value="Maridajes">Maridajes</option>
                          <option value="Cocteles">Cocteles</option>
                        </select>
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evMonth">Mes</label>
                        <select class="select" id="evMonth" required>
                          <option>ENERO</option><option>FEBRERO</option><option>MARZO</option><option>ABRIL</option>
                          <option>MAYO</option><option>JUNIO</option><option>JULIO</option><option>AGOSTO</option>
                          <option>SEPTIEMBRE</option><option>OCTUBRE</option><option>NOVIEMBRE</option><option>DICIEMBRE</option>
                        </select>
                      </div>

                      <!-- ✅ Mantener evImg como mobile/fallback (compat + admin.js) -->
                      <div class="field">
                        <label class="label" for="evImg">Imagen (url) — mobile / fallback</label>
                        <input class="input" id="evImg" type="text" placeholder="https://…" />
                      </div>
                    </div>

                    <!-- ✅ NUEVO: imagen desktop (no rompe si DB no tiene columna / admin.js ya hace fallback) -->
                    <div class="row">
                      <div class="field">
                        <label class="label" for="evImgDesktop">Imagen (url) — desktop</label>
                        <input class="input" id="evImgDesktop" type="text" placeholder="https://…/hero-desktop.webp" />
                        <div class="mini">
                          Opcional. Si lo dejás vacío, se usa la imagen de mobile/fallback.
                        </div>
                      </div>
                      <div class="field">
                        <label class="label" for="evImgMobile">Imagen (url) — mobile (opcional)</label>
                        <input class="input" id="evImgMobile" type="text" placeholder="https://…/hero-mobile.webp" />
                        <div class="mini">
                          Opcional. Si no lo usás, <b>evImg</b> sigue siendo el fallback principal.
                        </div>
                      </div>
                    </div>

                    <!-- ✅ VIDEO URL DESKTOP + VER MÁS -->
                    <div class="row">
                      <div class="field">
                        <label class="label" for="evVideoUrl">Video (url) — desktop (MP4/WebM)</label>
                        <input class="input" id="evVideoUrl" type="text" placeholder="https://…/hero.mp4" />
                        <div class="mini">
                          Tip: usá el tab <b>Medios</b>, seleccioná bucket <b>video</b> y pegá aquí la URL pública.
                        </div>
                      </div>

                      <div class="field">
                        <label class="label" for="evMoreImg">Imagen “Ver más” (url)</label>
                        <input class="input" id="evMoreImg" type="text" placeholder="https://…/detalle.webp" />
                        <div class="mini">
                          Opcional. Para una imagen adicional en la sección “Ver más”.
                        </div>
                      </div>
                    </div>

                    <div class="field">
                      <label class="label" for="evMoreImgAlt">Texto alternativo “Ver más”</label>
                      <input class="input" id="evMoreImgAlt" type="text" placeholder="Descripción corta de la imagen" maxlength="120" />
                      <div class="mini">
                        Opcional. Ayuda con accesibilidad/SEO.
                      </div>
                    </div>

                    <div class="field">
                      <label class="label" for="evDesc">Descripción</label>
                      <textarea class="textarea" id="evDesc" rows="4" maxlength="520"></textarea>
                      <div class="mini">Caracteres: <span id="descCount">0</span>/520</div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evLocation">Lugar</label>
                        <input class="input" id="evLocation" type="text" maxlength="80" />
                      </div>
                      <div class="field">
                        <label class="label" for="evTimeRange">Horario</label>
                        <input class="input" id="evTimeRange" type="text" placeholder="7:00pm - 9:00pm" maxlength="40" />
                      </div>
                    </div>

                    <!-- ✅ PRECIO -->
                    <div class="row">
                      <div class="field">
                        <label class="label" for="evPriceAmount">Precio</label>
                        <input class="input" id="evPriceAmount" type="number" min="0" step="0.01" placeholder="49.00" />
                      </div>
                      <div class="field">
                        <label class="label" for="evPriceCurrency">Moneda</label>
                        <select class="select" id="evPriceCurrency">
                          <option value="USD">USD</option>
                          <option value="CRC">CRC</option>
                        </select>
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evDurationHours">Duración (horas)</label>
                        <input class="input" id="evDurationHours" type="text" placeholder="2" maxlength="10" />
                      </div>
                      <div class="field">
                        <label class="label" for="evDuration">Duración (texto)</label>
                        <input class="input" id="evDuration" type="text" placeholder="2 hrs" maxlength="30" />
                      </div>
                    </div>

                    <div id="datesList"></div>

                    <div class="formActions">
                      <button class="btn primary" id="saveEventBtn" type="submit">Guardar</button>
                      <button class="btn" id="deleteEventBtn" type="button">Eliminar</button>
                      <button class="btn btn--ghost" id="addDateBtn" type="button">Administrar fechas</button>
                    </div>

                    <div class="note" id="eventNote" aria-live="polite"></div>
                  </form>
                </div>
              </div>
            </section>

            <!-- =====================================================
                 DATES
            ====================================================== -->
            <section class="panel" id="tab-dates" role="tabpanel" hidden>
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Eventos</h3>
                    <div class="mini">Seleccioná un evento para ver/crear fechas.</div>
                  </div>

                  <div class="toolbar">
                    <button class="btn" id="datesRefreshBtn" type="button">Refrescar</button>
                  </div>

                  <div class="note" id="datesNote" aria-live="polite"></div>
                  <div class="list" id="datesEventList"></div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3" id="datesEventTitle">Fechas</h3>
                    <div class="mini" id="datesEventMeta">—</div>
                  </div>

                  <div class="toolbar">
                    <button class="btn primary" id="datesNewBtn" type="button">+ Nueva fecha</button>
                  </div>

                  <div class="empty" id="datesEmpty">
                    Seleccioná un evento a la izquierda para administrar sus fechas.
                  </div>

                  <div id="datesEditor" hidden>
                    <div class="list" id="datesListByEvent"></div>

                    <form class="form" id="dateForm" autocomplete="off">
                      <input type="hidden" id="dateId" />

                      <div class="field">
                        <label class="label" for="dateLabel">Label</label>
                        <input class="input" id="dateLabel" type="text" placeholder="Sábado 18 • 7pm" maxlength="40" required />
                      </div>

                      <div class="row">
                        <div class="field">
                          <label class="label" for="dateSeatsTotal">Cupos totales</label>
                          <input class="input" id="dateSeatsTotal" type="number" min="0" step="1" value="0" />
                        </div>
                        <div class="field">
                          <label class="label" for="dateSeatsAvailable">Cupos disponibles</label>
                          <input class="input" id="dateSeatsAvailable" type="number" min="0" step="1" value="0" />
                        </div>
                      </div>

                      <div class="formActions">
                        <button class="btn primary" id="dateSaveBtn" type="submit">Guardar</button>
                        <button class="btn" id="dateClearBtn" type="button">Nueva</button>
                        <button class="btn" id="dateDeleteBtn" type="button" disabled>Eliminar</button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>
            </section>

            <!-- =====================================================
                 REGISTRATIONS
            ====================================================== -->
            <section class="panel" id="tab-regs" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Inscripciones</h3>
                  <div class="mini">Listado (solo lectura) con exportación CSV.</div>
                </div>

                <div class="toolbar">
                  <button class="btn" id="seedRegsBtn" type="button">Refrescar</button>
                  <button class="btn primary" id="exportCsvBtn" type="button">Exportar CSV</button>
                </div>

                <div class="tableWrap">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Evento</th>
                        <th>Fecha</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Marketing</th>
                        <th>Creado</th>
                      </tr>
                    </thead>
                    <tbody id="regsTbody"></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- =====================================================
                 MEDIA
            ====================================================== -->
            <section class="panel" id="tab-media" role="tabpanel" hidden>
              <div class="grid2">

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Medios</h3>
                    <div class="mini">
                      Subí imágenes o videos (según bucket) y copiá la URL para usarla en Eventos/Promos.
                      <br />
                      <b>Límite recomendado:</b> 25 MB por archivo.
                    </div>
                  </div>

                  <!-- ✅ Compat -->
                  <div id="mediaEditorEmpty" class="empty" hidden>Seleccioná un ítem o subí uno nuevo.</div>

                  <!-- ✅ data-max-mb: lo usa la validación de este HTML (y no rompe tu JS) -->
                  <form class="form" id="mediaForm" autocomplete="off" data-max-mb="25">
                    <!-- ✅ Compat -->
                    <input type="hidden" id="mediaId" value="" />
                    <input type="hidden" id="mediaTitle" value="" />
                    <input type="hidden" id="mediaKind" value="image" />
                    <input type="hidden" id="mediaTags" value="" />

                    <div class="field">
                      <label class="label" for="mediaFile">Archivo (JPG/PNG/WebP/MP4/WebM)</label>
                      <input class="input" id="mediaFile" type="file" accept="image/*,video/*" required />
                      <div class="mini">
                        Tip: Si subís MP4/WebM, seleccioná bucket <b>video</b>.
                        <span style="opacity:.85;">(Máx: <b>25 MB</b>)</span>
                      </div>
                    </div>

                    <div class="row">
                      <!-- ✅ BUCKET SELECTOR (PRO) -->
                      <div class="field">
                        <label class="label" for="mediaBucket">Bucket</label>
                        <select class="select" id="mediaBucket">
                          <option value="media">media (imágenes)</option>
                          <option value="video">video (videos)</option>
                        </select>
                        <div class="mini">La lista y la subida trabajan sobre el bucket seleccionado.</div>
                      </div>

                      <div class="field">
                        <label class="label" for="mediaFolder">Carpeta</label>
                        <select class="select" id="mediaFolder">
                          <option value="events">events</option>
                          <option value="promos">promos</option>
                          <option value="gallery">gallery</option>
                          <option value="misc">misc</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="mediaName">Nombre (opcional)</label>
                        <input class="input" id="mediaName" type="text" placeholder="hero-enero" maxlength="80" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="mediaUrl">URL pública</label>
                        <input class="input" id="mediaUrl" type="text" readonly placeholder="(se llena al subir)" />
                      </div>

                      <div class="field">
                        <label class="label">&nbsp;</label>
                        <div class="formActions" style="justify-content:flex-start;">
                          <button class="btn primary" id="mediaUploadBtn" type="submit">Subir</button>
                          <button class="btn" id="mediaCopyBtn" type="button">Copiar URL</button>
                          <button class="btn btn--ghost" id="mediaResetBtn" type="button">Limpiar</button>
                          <button class="btn" id="deleteMediaBtn" type="button" hidden>Eliminar</button>
                        </div>
                      </div>
                    </div>

                    <div class="note" id="mediaNote" aria-live="polite"></div>
                  </form>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Vista previa</h3>
                    <div class="mini">Verificá el archivo y luego copiá la URL.</div>
                  </div>

                  <div class="empty" id="mediaPreviewEmpty">Seleccioná un archivo para previsualizar.</div>

                  <!-- admin-media.js usa #mediaPreview como contenedor (no requiere mediaPreviewImg) -->
                  <div id="mediaPreview" hidden>
                    <img id="mediaPreviewImg" alt="Preview" style="width:100%; height:auto; border:1px solid rgba(255,255,255,.10);" />
                    <div class="note" id="mediaPreviewMeta"></div>
                  </div>

                  <div class="toolbar" style="margin-top:12px;">
                    <button class="btn" id="mediaRefreshBtn" type="button">Refrescar lista</button>
                  </div>

                  <div class="list" id="mediaList" aria-label="Lista de medios">
                    <!-- JS -->
                  </div>
                </div>

              </div>
            </section>

            <!-- =====================================================
                 GALLERY
            ====================================================== -->
            <section class="panel" id="tab-gallery" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Galería</h3>
                  <div class="mini">Subí y organizá imágenes para Maridajes / Cocteles.</div>
                </div>

                <div class="toolbar">
                  <button class="btn primary" id="newGalleryBtn" type="button">Nuevo ítem</button>
                  <button class="btn" id="refreshGalleryBtn" type="button">Refrescar</button>
                </div>

                <!-- ✅ Compat: si un JS viejo usa lista + form -->
                <div id="galleryList" hidden></div>
                <form id="galleryForm" hidden></form>

                <div class="tableWrap">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Tipo</th>
                        <th>Nombre</th>
                        <th>Tags</th>
                        <th>Imagen</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="galleryTbody"></tbody>
                  </table>
                </div>
              </div>
            </section>

            <!-- =====================================================
                 PROMOS
            ====================================================== -->
            <section class="panel" id="tab-promos" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Promos</h3>
                  <div class="mini">Administración de promos.</div>
                </div>

                <div class="toolbar">
                  <button class="btn primary" id="newPromoBtn" type="button">Nueva promo</button>
                  <button class="btn" id="refreshPromosBtn" type="button">Refrescar</button>
                </div>

                <!-- ✅ Compat: si un JS viejo usa lista + form -->
                <div id="promosList" hidden></div>
                <form id="promoForm" hidden></form>

                <div class="tableWrap">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Tipo</th>
                        <th>Título</th>
                        <th>Target</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="promosTbody"></tbody>
                  </table>
                </div>
              </div>
            </section>

          </div><!-- /adminContent -->
        </div><!-- /adminLayout -->

      </section>
    </div>
  </main>

  <!-- SCRIPTS (ORDEN CRÍTICO) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="./js/supabaseClient.js" defer></script>
  <script src="./js/admin-auth.js" defer></script>

  <script src="./js/admin.js" defer></script>
  <script src="./js/admin-dates.js" defer></script>
  <script src="./js/admin-registrations.js" defer></script>

  <script src="./js/admin-media.js" defer></script>
  <script src="./js/admin-gallery.js" defer></script>
  <script src="./js/admin-promos.js" defer></script>

  <!-- ✅ PATCH 2026-02-15: Validación tamaño de archivo (25MB) SOLO UI
       - No rompe tu admin-media.js (no toca tus handlers, solo bloquea submit si excede).
  -->
  <script>
    (function () {
      "use strict";

      const form = document.getElementById("mediaForm");
      const file = document.getElementById("mediaFile");

      // Si no existe, salimos.
      if (!form || !file) return;

      // Toast helper compatible con tu contenedor #toasts
      const toastsEl = document.getElementById("toasts");
      const escapeHtml = (s) =>
        String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");

      const toast = (title, msg, timeout = 4200) => {
        if (!toastsEl) return alert(title + " — " + msg);

        const el = document.createElement("div");
        el.className = "toast";
        el.innerHTML = `
          <div>
            <p class="tTitle">${escapeHtml(title)}</p>
            <p class="tMsg">${escapeHtml(msg)}</p>
          </div>
          <button class="close" aria-label="Cerrar">✕</button>
        `;
        toastsEl.appendChild(el);

        const kill = () => {
          try {
            el.style.opacity = "0";
            el.style.transform = "translateY(-6px)";
            setTimeout(() => el.remove(), 180);
          } catch (_) {}
        };

        el.querySelector(".close")?.addEventListener("click", kill, { once: true });
        setTimeout(kill, timeout);
      };

      const getMaxBytes = () => {
        const raw = form.getAttribute("data-max-mb");
        const mb = Number(raw || 25);
        const safe = Number.isFinite(mb) && mb > 0 ? mb : 25;
        return safe * 1024 * 1024;
      };

      const fmtMB = (bytes) => (bytes / (1024 * 1024)).toFixed(2) + " MB";

      // Validación al elegir archivo (feedback inmediato)
      file.addEventListener("change", () => {
        const f = file.files && file.files[0];
        if (!f) return;

        const max = getMaxBytes();
        if (f.size > max) {
          toast("Archivo muy grande", `Máximo permitido: ${fmtMB(max)}. Tu archivo: ${fmtMB(f.size)}.`);
        }
      });

      // Validación antes de subir (bloquea submit si excede)
      form.addEventListener(
        "submit",
        (e) => {
          const f = file.files && file.files[0];
          if (!f) return;

          const max = getMaxBytes();
          if (f.size > max) {
            e.preventDefault();
            e.stopPropagation();
            toast("No se puede subir", `El archivo excede ${fmtMB(max)}. Reducilo o exportalo más liviano.`);
          }
        },
        true
      );
    })();
  </script>
</body>
</html>
