<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <title>Admin | Entre Copas &amp; Notas</title>
  <meta name="description" content="Panel de administración para eventos e inscripciones." />
  <link rel="stylesheet" href="./css/admin.css" />
</head>

<body class="adminPage" data-page="admin">
  <div class="toasts" id="toasts" aria-live="polite" aria-relevant="additions"></div>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="container">
      <div class="nav">
        <a class="brand" href="./index.html" aria-label="Ir al sitio público">
          <img id="adminLogo" src="./assets/img/logocuadrado-entrecopasynotas.png" alt="Logo" />
          <span>Admin · Entre Copas &amp; Notas</span>
        </a>

        <div class="navRight">
          <a class="btn" href="https://entrecopasynotas.com">Ver sitio</a>
          <button class="btn" id="logoutBtn" type="button">Salir</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="page">
    <div class="container">

      <section class="app" id="appPanel">

        <!-- HEADER / SEARCH -->
        <div class="head">
          <div>
            <p class="kicker">Gestión</p>
            <h2 class="h2">Panel de administración</h2>
            <p class="sub">Eventos, fechas, cupos, inscripciones y recursos visuales.</p>
          </div>

          <div class="headActions">
            <input
              class="search"
              id="search"
              type="search"
              placeholder="Buscar evento o inscripción…"
              aria-label="Buscar"
              autocomplete="off"
            />
          </div>
        </div>

        <!-- =====================================================
             SIDEBAR LAYOUT WRAP
        ====================================================== -->
        <div class="adminLayout">

          <!-- SIDEBAR (tabs) -->
          <aside class="adminSide" aria-label="Navegación">
            <div class="sideCard">

              <div class="sideTitle">
                <div class="sideKicker">Secciones</div>
                <div class="sideHint">Elegí una vista</div>
              </div>

              <!-- TABS -->
              <div class="tabs sideTabs" role="tablist" aria-label="Secciones">
                <button class="tab" data-tab="events" aria-selected="true" type="button">Eventos</button>
                <button class="tab" data-tab="dates" aria-selected="false" type="button">Fechas</button>
                <button class="tab" data-tab="regs" aria-selected="false" type="button">Inscripciones</button>
                <button class="tab" data-tab="media" aria-selected="false" type="button">Medios</button>
                <button class="tab" data-tab="gallery" aria-selected="false" type="button">Galería</button>
                <button class="tab" data-tab="promos" aria-selected="false" type="button">Promos</button>
              </div>

              <div class="sideFooter">
                <div class="sideChip">Tip</div>
                <div class="sideFootText">Usá el buscador arriba para filtrar rápido.</div>
              </div>
            </div>
          </aside>

          <!-- CONTENT (paneles) -->
          <div class="adminContent">

            <!-- =====================================================
                 EVENTS
            ====================================================== -->
            <section class="panel" id="tab-events" role="tabpanel">
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Eventos</h3>
                    <div class="mini">Crear, editar y publicar eventos.</div>
                  </div>

                  <div class="listHead">
                    <div class="pill">Lista</div>
                    <div class="actions">
                      <button class="btn btn--ghost" id="newEventBtn" type="button">Nuevo</button>
                      <button class="btn btn--ghost" id="dupEventBtn" type="button">Duplicar</button>
                    </div>
                  </div>

                  <div id="eventsList" hidden></div>

                  <div class="list" id="eventList" aria-label="Lista de eventos">
                    <!-- JS -->
                  </div>

                  <div class="empty" id="eventsEmpty" hidden>
                    Aún no hay eventos. Creá el primero con “Nuevo”.
                  </div>

                  <div class="note" id="storageNote" aria-live="polite"></div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Editor</h3>
                    <div class="mini">Completá la info del evento y guardá cambios.</div>
                  </div>

                  <div class="empty" id="editorEmpty">
                    Seleccioná un evento de la lista para editarlo.
                  </div>

                  <input id="eventTitle" type="hidden" value="" />
                  <input id="eventType" type="hidden" value="" />
                  <input id="eventMonthKey" type="hidden" value="" />

                  <form class="form" id="eventForm" autocomplete="off" hidden>
                    <input type="hidden" id="eventId" />

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evTitle">Título</label>
                        <input class="input" id="evTitle" type="text" required maxlength="80" />
                      </div>
                      <div class="field">
                        <label class="label" for="evType">Tipo</label>
                        <select class="select" id="evType" required>
                          <option value="Cata de vino">Vino / Cata</option>
                          <option value="Maridajes">Maridajes</option>
                          <option value="Cocteles">Cocteles</option>
                        </select>
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evMonth">Mes</label>
                        <select class="select" id="evMonth" required>
                          <option>ENERO</option><option>FEBRERO</option><option>MARZO</option><option>ABRIL</option>
                          <option>MAYO</option><option>JUNIO</option><option>JULIO</option><option>AGOSTO</option>
                          <option>SEPTIEMBRE</option><option>OCTUBRE</option><option>NOVIEMBRE</option><option>DICIEMBRE</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="evImg">Imagen (url) — fallback</label>
                        <input class="input" id="evImg" type="text" placeholder="Gestionar en Medios" />
                        <div class="mini">Estas URLs se administran en <b>Medios</b> (asignación por slot).</div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evImgDesktop">Imagen (url) — desktop</label>
                        <input class="input" id="evImgDesktop" type="text" placeholder="Gestionar en Medios" />
                        <div class="mini">Solo lectura aquí. Asigná en <b>Medios</b>.</div>
                      </div>
                      <div class="field">
                        <label class="label" for="evImgMobile">Imagen (url) — mobile</label>
                        <input class="input" id="evImgMobile" type="text" placeholder="Gestionar en Medios" />
                        <div class="mini">Solo lectura aquí. Asigná en <b>Medios</b>.</div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evVideoUrl">Video (url) — desktop</label>
                        <input class="input" id="evVideoUrl" type="text" placeholder="Gestionar en Medios" />
                        <div class="mini">Solo lectura aquí. Asigná en <b>Medios</b> usando bucket <b>video</b>.</div>
                      </div>

                      <div class="field">
                        <label class="label" for="evMoreImg">Imagen “Ver más” (url)</label>
                        <input class="input" id="evMoreImg" type="text" placeholder="Gestionar en Medios" />
                        <div class="mini">Solo lectura aquí. Asigná en <b>Medios</b>.</div>
                      </div>
                    </div>

                    <div class="field">
                      <label class="label" for="evMoreImgAlt">Texto alternativo “Ver más”</label>
                      <input class="input" id="evMoreImgAlt" type="text" placeholder="Descripción corta de la imagen" maxlength="120" />
                      <div class="mini">Opcional. Ayuda con accesibilidad/SEO.</div>
                    </div>

                    <div class="field">
                      <label class="label" for="evDesc">Descripción</label>
                      <textarea class="textarea" id="evDesc" rows="4" maxlength="520"></textarea>
                      <div class="mini">Caracteres: <span id="descCount">0</span>/520</div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evLocation">Lugar</label>
                        <input class="input" id="evLocation" type="text" maxlength="80" />
                      </div>
                      <div class="field">
                        <label class="label" for="evTimeRange">Horario</label>
                        <input class="input" id="evTimeRange" type="text" maxlength="40" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evDurationHours">Duración (horas)</label>
                        <input class="input" id="evDurationHours" type="number" min="0" step="0.5" />
                      </div>
                      <div class="field">
                        <label class="label" for="evPriceAmount">Precio</label>
                        <input class="input" id="evPriceAmount" type="number" min="0" step="100" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="evPriceCurrency">Moneda</label>
                        <input class="input" id="evPriceCurrency" type="text" maxlength="10" placeholder="CRC" />
                      </div>
                    </div>

                    <div class="formActions">
                      <button class="btn primary" id="saveEventBtn" type="submit">Guardar</button>
                      <button class="btn btn--ghost" id="delEventBtn" type="button">Eliminar</button>
                    </div>

                    <div class="note" id="eventNote"></div>
                  </form>
                </div>
              </div>
            </section>

            <!-- =====================================================
                 DATES
            ====================================================== -->
            <section class="panel" id="tab-dates" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Fechas</h3>
                  <div class="mini">Administrá fechas y cupos por evento.</div>
                </div>
                <div class="list" id="datesList"><!-- JS --></div>
              </div>
            </section>

            <!-- =====================================================
                 REGS
            ====================================================== -->
            <section class="panel" id="tab-regs" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Inscripciones</h3>
                  <div class="mini">Revisá registros y estado.</div>
                </div>
                <div class="list" id="regsList"><!-- JS --></div>
              </div>
            </section>

            <!-- =====================================================
                 MEDIA (PRO, único lugar)
            ====================================================== -->
            <section class="panel" id="tab-media" role="tabpanel" hidden>
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Medios</h3>
                    <div class="mini">
                      Subí imágenes o videos (según bucket) y copiá/pegá la URL para usarla en Eventos/Promos/Menú.
                      <br/>Límite recomendado: 25 MB por archivo.
                    </div>
                  </div>

                  <form class="form" id="mediaForm" data-max-mb="25">
                    <input type="hidden" id="mediaId" />

                    <div class="row">
                      <div class="field">
                        <label class="label" for="mediaBucket">Bucket</label>
                        <select class="select" id="mediaBucket">
                          <option value="media">media (imágenes)</option>
                          <option value="video">video (videos)</option>
                        </select>
                        <div class="mini">La lista y la subida trabajan sobre el bucket seleccionado.</div>
                      </div>

                      <div class="field">
                        <label class="label" for="mediaFolder">Folder</label>
                        <input class="input" id="mediaFolder" type="text" placeholder="events | promos | menu | misc" />
                        <div class="mini">Se guarda en DB como <b>folder</b> y en Storage como subcarpeta.</div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="mediaName">Nombre</label>
                        <input class="input" id="mediaName" type="text" placeholder="Ej: hero-febrero" />
                      </div>

                      <div class="field">
                        <label class="label" for="mediaTags">Tags (opcional)</label>
                        <input class="input" id="mediaTags" type="text" placeholder="#vino #maridaje" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="field">
                        <label class="label" for="mediaFile">Archivo</label>
                        <input class="input" id="mediaFile" type="file" />
                        <div class="mini">Elegí un archivo y presioná “Subir”.</div>
                      </div>

                      <div class="field">
                        <label class="label" for="mediaUrl">URL pública</label>
                        <input class="input" id="mediaUrl" type="text" placeholder="Pegá una URL o se llena al subir..." />
                        <div class="mini">Podés pegar una URL (http/https) y se guarda como asset.</div>
                      </div>
                    </div>

                    <div class="formActions" style="justify-content:flex-start;">
                      <button class="btn primary" id="mediaUploadBtn" type="submit">Subir</button>
                      <button class="btn" id="mediaCopyBtn" type="button">Copiar URL</button>
                      <button class="btn btn--ghost" id="mediaResetBtn" type="button">Limpiar</button>
                      <button class="btn btn--ghost" id="deleteMediaBtn" type="button">Eliminar</button>
                    </div>

                    <div class="note" id="mediaNote" aria-live="polite"></div>
                  </form>

                  <div class="empty" id="mediaEditorEmpty" hidden></div>

                  <div class="card" style="margin-top:14px;">
                    <div class="cardHead">
                      <h3 class="h3" id="mediaTitle">Preview</h3>
                      <div class="mini">Seleccioná un medio de la lista para ver y asignar.</div>
                    </div>

                    <div class="empty" id="mediaPreviewEmpty">No hay medio seleccionado.</div>

                    <div id="mediaPreview" hidden>
                      <div style="border:1px solid rgba(255,255,255,.10); border-radius:18px; overflow:hidden;">
                        <img id="mediaPreviewImg" alt="" style="width:100%; height:auto; display:block;"/>
                      </div>
                      <div class="note" id="mediaPreviewMeta"></div>
                    </div>

                    <div class="toolbar" style="margin-top:12px;">
                      <button class="btn" id="mediaRefreshBtn" type="button">Refrescar lista</button>
                    </div>

                    <div class="list" id="mediaList" aria-label="Lista de medios">
                      <!-- JS -->
                    </div>
                  </div>

                  <!-- ASIGNAR (PRO) -->
                  <div class="card" style="margin-top:14px;">
                    <div class="cardHead">
                      <h3 class="h3">Asignar</h3>
                      <div class="mini">Usá el medio seleccionado para asignarlo a un <b>evento</b> o a un <b>ítem del menú</b>.</div>
                    </div>

                    <div class="form">
                      <div class="row">
                        <div class="field">
                          <label class="label" for="mediaScopeType">Tipo</label>
                          <select class="select" id="mediaScopeType">
                            <option value="event">Evento</option>
                            <option value="menu_item">Menú</option>
                          </select>
                        </div>

                        <div class="field" id="mediaScopeEventWrap">
                          <label class="label" for="mediaEventSelect">Evento</label>
                          <select class="select" id="mediaEventSelect">
                            <option value="">Seleccionar evento…</option>
                          </select>
                        </div>

                        <div class="field" id="mediaScopeMenuWrap" hidden>
                          <label class="label" for="mediaMenuSelect">Ítem de menú</label>
                          <select class="select" id="mediaMenuSelect">
                            <option value="">Seleccionar ítem…</option>
                          </select>
                        </div>
                      </div>

                      <div class="row">
                        <div class="field">
                          <label class="label" for="mediaSlotSelect">Slot</label>
                          <select class="select" id="mediaSlotSelect"></select>
                        </div>

                        <div class="field">
                          <label class="label">&nbsp;</label>
                          <div class="formActions" style="justify-content:flex-start;">
                            <button class="btn primary" id="mediaAssignBtn" type="button">Asignar</button>
                            <button class="btn" id="mediaViewAssignedBtn" type="button">Ver asignados</button>
                          </div>
                        </div>
                      </div>

                      <div class="list" id="mediaAssignedList" aria-label="Asignados"></div>
                    </div>
                  </div>

                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Ayuda rápida</h3>
                    <div class="mini">
                      <b>Eventos</b> muestra URLs (solo lectura).<br/>
                      <b>Medios</b> es el único lugar para subir y asignar.
                    </div>
                  </div>

                  <div class="empty">
                    Flujo recomendado:
                    <ol style="margin:10px 0 0; padding-left:18px; line-height:1.6;">
                      <li>Seleccioná bucket <b>media</b> o <b>video</b></li>
                      <li>Subí o pegá una URL</li>
                      <li>Seleccioná el medio en la lista</li>
                      <li>Asigná a evento/menú y slot</li>
                    </ol>
                  </div>
                </div>
              </div>
            </section>

            <!-- =====================================================
                 GALLERY
            ====================================================== -->
            <section class="panel" id="tab-gallery" role="tabpanel" hidden>
              <!-- JS por admin-gallery.js -->
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Galería</h3>
                  <div class="mini">Administración de imágenes para galería.</div>
                </div>
                <div class="list" id="galleryTbody"><!-- JS --></div>
              </div>
            </section>

            <!-- =====================================================
                 PROMOS
            ====================================================== -->
            <section class="panel" id="tab-promos" role="tabpanel" hidden>
              <!-- JS por admin-promos.js -->
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Promos</h3>
                  <div class="mini">Administración de promociones.</div>
                </div>
                <div class="list" id="promosList"><!-- JS --></div>
              </div>
            </section>

          </div><!-- /adminContent -->
        </div><!-- /adminLayout -->
      </section>

    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./js/supabaseClient.js"></script>
  <script src="./js/admin-auth.js"></script>
  <script src="./js/admin.js"></script>
  <script src="./js/admin-dates.js"></script>
  <script src="./js/admin-registrations.js"></script>
  <script src="./js/admin-media.js"></script>
  <script src="./js/admin-gallery.js"></script>
  <script src="./js/admin-promos.js"></script>

  <!-- Validación liviana de tamaño (no interfiere con admin-media.js) -->
  <script>
    (function () {
      "use strict";

      const form = document.getElementById("mediaForm");
      const file = document.getElementById("mediaFile");
      if (!form || !file) return;

      const toast = (t, m) => {
        try { if (window.APP && typeof APP.toast === "function") return APP.toast(t, m, 3400); } catch (_) {}
        alert(t + " — " + m);
      };

      const getMaxBytes = () => {
        const raw = form.getAttribute("data-max-mb");
        const mb = Number(raw || 25);
        const safe = Number.isFinite(mb) && mb > 0 ? mb : 25;
        return safe * 1024 * 1024;
      };

      const fmtMB = (bytes) => (bytes / (1024 * 1024)).toFixed(2) + " MB";

      file.addEventListener("change", () => {
        const f = file.files && file.files[0];
        if (!f) return;
        const max = getMaxBytes();
        if (f.size > max) toast("Archivo muy grande", `Máximo: ${fmtMB(max)}. Tu archivo: ${fmtMB(f.size)}.`);
      });

      form.addEventListener(
        "submit",
        (e) => {
          const f = file.files && file.files[0];
          if (!f) return;
          const max = getMaxBytes();
          if (f.size > max) {
            e.preventDefault();
            e.stopPropagation();
            toast("No se puede subir", `El archivo excede ${fmtMB(max)}. Reducilo o exportalo más liviano.`);
          }
        },
        true
      );
    })();
  </script>
</body>
</html>