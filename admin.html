<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <title>Admin | Entre Copas &amp; Notas</title>
  <meta name="description" content="Panel de administración para eventos, fechas, inscripciones y medios." />
  <link rel="stylesheet" href="./css/admin.css" />

  <!-- FIX CRÍTICO: si un elemento tiene hidden, NO puede quedar visible por CSS -->
  <style>
    [hidden]{ display:none !important; }
  </style>
</head>

<body class="adminPage" data-page="admin">
  <div class="toasts" id="toasts" aria-live="polite" aria-relevant="additions"></div>

  <header class="topbar">
    <div class="container">
      <div class="nav">
        <a class="brand" href="./index.html" aria-label="Ir al sitio público">
          <img id="adminLogo" src="./assets/img/logocuadrado-entrecopasynotas.png" alt="Logo" />
          <span class="brandText">Admin · Entre Copas &amp; Notas</span>
        </a>

        <div class="navRight">
          <a class="btn btn--ghost" href="./index.html" id="viewSiteBtn">VER SITIO</a>
          <button class="btn btn--ghost" id="logoutBtn" type="button">SALIR</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- AUTH GATE (lo maneja admin-auth.js) -->
    <section class="authGate" id="authGate" hidden>
      <div class="card">
        <div class="cardHead">
          <h2 class="h2">Acceso</h2>
          <div class="mini">Iniciá sesión para administrar el contenido.</div>
        </div>
        <div class="content">
          <p class="muted">Redirigiendo al login…</p>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="appPanel" id="appPanel" hidden>
      <div class="adminShell">

        <aside class="sidebar">
          <div class="sideCard">
            <div class="sideHead">
              <div class="kicker">SECCIONES</div>
              <div class="sideTitle">Elegí una vista</div>
            </div>

            <nav class="sideNav tabs sideTabs" role="tablist" aria-label="Secciones del administrador">
              <button class="navBtn tab isActive" type="button" data-tab="events" aria-selected="true">EVENTOS</button>
              <button class="navBtn tab" type="button" data-tab="dates" aria-selected="false">FECHAS</button>
              <button class="navBtn tab" type="button" data-tab="regs" aria-selected="false">INSCRIPCIONES</button>
              <button class="navBtn tab" type="button" data-tab="media" aria-selected="false">MEDIOS</button>
              <button class="navBtn tab" type="button" data-tab="gallery" aria-selected="false">GALERÍA</button>
              <button class="navBtn tab" type="button" data-tab="promos" aria-selected="false">PROMOS</button>
            </nav>

            <div class="sideFoot sideFooter">
              <span class="sideChip">TIP</span>
              <span class="sideFootText">Usá el buscador arriba para filtrar rápido.</span>
            </div>
          </div>
        </aside>

        <section class="content adminContent">
          <div class="pageHead">
            <div>
              <div class="kicker">GESTIÓN</div>
              <h1 class="h1">Panel de administración</h1>
              <div class="mini">Eventos, fechas, cupos, inscripciones y recursos visuales.</div>
            </div>

            <div class="pageTools">
              <label class="srOnly" for="search">Buscar</label>
              <input class="input input--search" id="search" type="search" placeholder="Buscar evento o inscripción" />
            </div>
          </div>

          <div class="tabs" aria-label="Vistas del administrador">

            <!-- EVENTOS -->
            <section class="panel" id="tab-events" role="tabpanel">
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Eventos</h3>
                    <div class="mini">Crear, editar y publicar eventos.</div>
                  </div>

                  <div class="listHead">
                    <div class="pill">Lista</div>
                    <div class="actions">
                      <button class="btn btn--ghost" id="newEventBtn" type="button">Nuevo</button>
                      <button class="btn btn--ghost" id="dupEventBtn" type="button">Duplicar</button>
                    </div>
                  </div>

                  <div id="eventsList" hidden></div>
                  <div class="list" id="eventList" aria-label="Lista de eventos"></div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Editor</h3>
                    <div class="mini">Datos principales del evento.</div>
                  </div>

                  <form class="form" id="eventForm" novalidate>
                    <input id="evId" type="hidden" />

                    <div class="formGrid">
                      <div class="field">
                        <label class="label" for="evTitle">Título</label>
                        <input class="input" id="evTitle" type="text" maxlength="120" required />
                      </div>

                      <div class="field">
                        <label class="label" for="evSlug">Slug (URL)</label>
                        <input class="input" id="evSlug" type="text" maxlength="120" placeholder="ej: cata-italia-vs-usa" />
                      </div>

                      <div class="field">
                        <label class="label" for="evPlace">Lugar</label>
                        <input class="input" id="evPlace" type="text" maxlength="120" />
                      </div>

                      <div class="field">
                        <label class="label" for="evSchedule">Horario</label>
                        <input class="input" id="evSchedule" type="text" maxlength="80" placeholder="ej: 7:00 pm a 9:00 pm" />
                      </div>

                      <div class="field">
                        <label class="label" for="evDurationHours">Duración (horas)</label>
                        <input class="input" id="evDurationHours" type="number" min="0" step="0.5" />
                      </div>

                      <div class="field">
                        <label class="label" for="evPriceAmount">Precio</label>
                        <input class="input" id="evPriceAmount" type="number" min="0" step="0.01" inputmode="decimal" />
                      </div>

                      <div class="field">
                        <label class="label" for="evCurrency">Moneda</label>
                        <select class="input" id="evCurrency">
                          <option value="CRC">CRC</option>
                          <option value="USD">USD</option>
                        </select>
                      </div>

                      <div class="field field--full">
                        <label class="label" for="evDesc">Descripción</label>
                        <textarea class="input textarea" id="evDesc" rows="5" maxlength="520"></textarea>
                        <div class="help">
                          <span id="evDescCount" class="muted">0/520</span>
                          <span class="muted">Opcional. Ayuda con accesibilidad/SEO.</span>
                        </div>
                      </div>

                      <div class="field field--full">
                        <div class="mediaRow">
                          <div>
                            <div class="kicker">BANNER (URL) — DESKTOP</div>
                            <button class="btn btn--ghost" id="evBannerDesktopBtn" type="button">Gestionar en Medios</button>
                            <div class="mini">Solo lectura aquí. Asigná en Medios (slot desktop_event).</div>
                            <input class="input" id="evBannerDesktopUrl" type="url" placeholder="(solo lectura)" readonly />
                          </div>

                          <div>
                            <div class="kicker">BANNER (URL) — MOBILE</div>
                            <button class="btn btn--ghost" id="evBannerMobileBtn" type="button">Gestionar en Medios</button>
                            <div class="mini">Solo lectura aquí. Asigná en Medios (slot mobile_event).</div>
                            <input class="input" id="evBannerMobileUrl" type="url" placeholder="(solo lectura)" readonly />
                          </div>
                        </div>
                      </div>

                      <div class="field field--full">
                        <label class="label" for="evAlt">Texto alternativo del banner</label>
                        <input class="input" id="evAlt" type="text" maxlength="140" placeholder="Opcional. Ayuda con accesibilidad/SEO." />
                      </div>

                      <div class="field">
                        <label class="label" for="evActive">Estado</label>
                        <select class="input" id="evActive">
                          <option value="true">Publicado</option>
                          <option value="false">Borrador</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="evBadge">Badge</label>
                        <input class="input" id="evBadge" type="text" maxlength="40" placeholder="ej: Cupos limitados" />
                      </div>
                    </div>

                    <div class="formActions">
                      <button class="btn btn--primary" id="saveEventBtn" type="submit">GUARDAR</button>
                      <button class="btn btn--danger" id="deleteEventBtn" type="button">ELIMINAR</button>
                    </div>
                  </form>
                </div>
              </div>
            </section>

            <!-- FECHAS -->
            <section class="panel" id="tab-dates" role="tabpanel" hidden>
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Fechas</h3>
                    <div class="mini">Administrá fechas y cupos por evento.</div>
                  </div>

                  <div class="listHead">
                    <div class="pill">Eventos</div>
                    <div class="actions">
                      <button class="btn btn--ghost" id="datesRefreshBtn" type="button">Actualizar</button>
                      <button class="btn btn--ghost" id="datesNewBtn" type="button">Nueva fecha</button>
                    </div>
                  </div>

                  <div class="note" id="datesNote"></div>
                  <div class="list" id="datesEventList" aria-label="Lista de eventos para fechas"></div>

                  <div class="empty" id="datesEmpty" hidden>
                    <p class="muted">Elegí un evento para ver y editar sus fechas.</p>
                  </div>
                </div>

                <div class="card" id="datesEditor" hidden>
                  <div class="cardHead">
                    <h3 class="h3" id="datesEventTitle">Evento</h3>
                    <div class="mini" id="datesEventMeta">Seleccioná una fecha para editar.</div>
                  </div>

                  <div class="split">
                    <div class="list" id="datesListByEvent" aria-label="Fechas del evento"></div>

                    <form class="form" id="dateForm" novalidate>
                      <input id="dateId" type="hidden" />

                      <div class="field">
                        <label class="label" for="dateLabel">Etiqueta</label>
                        <input class="input" id="dateLabel" type="text" maxlength="120" placeholder="ej: Viernes 7pm" />
                      </div>

                      <div class="formGrid">
                        <div class="field">
                          <label class="label" for="dateSeatsTotal">Cupos totales</label>
                          <input class="input" id="dateSeatsTotal" type="number" min="0" step="1" />
                        </div>
                        <div class="field">
                          <label class="label" for="dateSeatsAvailable">Cupos disponibles</label>
                          <input class="input" id="dateSeatsAvailable" type="number" min="0" step="1" />
                        </div>
                      </div>

                      <div class="formActions">
                        <button class="btn btn--primary" id="dateSaveBtn" type="submit">GUARDAR</button>
                        <button class="btn btn--danger" id="dateDeleteBtn" type="button">ELIMINAR</button>
                        <button class="btn btn--ghost" id="dateClearBtn" type="button">LIMPIAR</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </section>

            <!-- INSCRIPCIONES -->
            <section class="panel" id="tab-regs" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Inscripciones</h3>
                  <div class="mini">Revisá registros y exportá CSV.</div>
                </div>

                <div class="listHead">
                  <div class="pill">Registros</div>
                  <div class="actions">
                    <button class="btn btn--ghost" id="exportCsvBtn" type="button">Exportar CSV</button>
                    <button class="btn btn--ghost" id="seedRegsBtn" type="button">Refrescar</button>
                  </div>
                </div>

                <div class="tableWrap">
                  <table class="table" aria-label="Tabla de inscripciones">
                    <thead>
                      <tr>
                        <th>Evento</th>
                        <th>Fecha</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Marketing</th>
                        <th class="right">Creado</th>
                      </tr>
                    </thead>
                    <tbody id="regsTbody"></tbody>
                  </table>
                </div>

                <div class="muted small">Tip: usá el buscador para filtrar por evento o email.</div>
              </div>
            </section>

            <!-- MEDIOS ✅ (Estructura completa para admin-media.js) -->
            <section class="panel" id="tab-media" role="tabpanel" hidden>
              <div class="grid2">
                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3">Medios</h3>
                    <div class="mini">Subí imágenes/videos, generá URL pública y asigná slots.</div>
                  </div>

                  <form class="form" id="mediaForm" data-max-mb="25">
                    <input type="hidden" id="mediaId" />

                    <div class="formGrid">
                      <div class="field">
                        <label class="label" for="mediaBucket">Bucket</label>
                        <select class="input" id="mediaBucket">
                          <option value="media">media (imágenes)</option>
                          <option value="video">video (videos)</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="mediaFolder">Folder</label>
                        <input class="input" id="mediaFolder" type="text" placeholder="events-img | promos-img | menu-img | misc-img" />
                      </div>

                      <div class="field">
                        <label class="label" for="mediaName">Nombre</label>
                        <input class="input" id="mediaName" type="text" placeholder="Ej: hero-febrero" />
                      </div>

                      <div class="field">
                        <label class="label" for="mediaTags">Tags</label>
                        <input class="input" id="mediaTags" type="text" placeholder="#vino #maridaje" />
                      </div>

                      <div class="field field--full">
                        <label class="label" for="mediaFile">Archivo</label>
                        <input class="input" id="mediaFile" type="file" />
                      </div>

                      <div class="field field--full">
                        <label class="label" for="mediaUrl">URL pública</label>
                        <input class="input" id="mediaUrl" type="text" placeholder="Se llena al subir o pegá una URL..." />
                      </div>
                    </div>

                    <div class="formActions" style="justify-content:flex-start;">
                      <button class="btn btn--primary" id="mediaUploadBtn" type="submit">SUBIR</button>
                      <button class="btn btn--ghost" id="mediaCopyBtn" type="button">COPIAR URL</button>
                      <button class="btn btn--ghost" id="mediaResetBtn" type="button">LIMPIAR</button>
                      <button class="btn btn--danger" id="deleteMediaBtn" type="button">ELIMINAR</button>
                    </div>

                    <div class="note" id="mediaNote" aria-live="polite"></div>
                  </form>

                  <div class="card" style="margin-top:14px;">
                    <div class="cardHead">
                      <h3 class="h3">Lista</h3>
                      <div class="mini">Seleccioná un medio para previsualizar y asignar.</div>
                    </div>

                    <div class="actions" style="margin-bottom:10px;">
                      <button class="btn btn--ghost" id="mediaRefreshBtn" type="button">Refrescar lista</button>
                    </div>

                    <div class="list" id="mediaList" aria-label="Lista de medios"></div>
                  </div>
                </div>

                <div class="card">
                  <div class="cardHead">
                    <h3 class="h3" id="mediaTitle">Preview</h3>
                    <div class="mini">Vista previa del medio seleccionado.</div>
                  </div>

                  <div id="mediaPreviewEmpty" class="muted">No hay medio seleccionado.</div>

                  <div id="mediaPreview" hidden>
                    <div class="preview">
                      <img id="mediaPreviewImg" alt="" />
                    </div>
                    <div class="note" id="mediaPreviewMeta"></div>
                  </div>

                  <div class="card" style="margin-top:14px;">
                    <div class="cardHead">
                      <h3 class="h3">Asignar</h3>
                      <div class="mini">Asigná el medio a un evento/menú y su slot.</div>
                    </div>

                    <div class="formGrid">
                      <div class="field">
                        <label class="label" for="mediaScopeType">Tipo</label>
                        <select class="input" id="mediaScopeType">
                          <option value="event">Evento</option>
                          <option value="menu_item">Menú</option>
                        </select>
                      </div>

                      <div class="field" id="mediaScopeEventWrap">
                        <label class="label" for="mediaEventSelect">Evento</label>
                        <select class="input" id="mediaEventSelect">
                          <option value="">Seleccionar evento…</option>
                        </select>
                      </div>

                      <div class="field" id="mediaScopeMenuWrap" hidden>
                        <label class="label" for="mediaMenuSelect">Ítem de menú</label>
                        <select class="input" id="mediaMenuSelect">
                          <option value="">Seleccionar ítem…</option>
                        </select>
                      </div>

                      <div class="field field--full">
                        <label class="label" for="mediaSlotSelect">Slot</label>
                        <select class="input" id="mediaSlotSelect"></select>
                      </div>
                    </div>

                    <div class="formActions" style="justify-content:flex-start;">
                      <button class="btn btn--primary" id="mediaAssignBtn" type="button">ASIGNAR</button>
                      <button class="btn btn--ghost" id="mediaViewAssignedBtn" type="button">VER ASIGNADOS</button>
                    </div>

                    <div class="list" id="mediaAssignedList" aria-label="Asignados"></div>
                  </div>
                </div>
              </div>
            </section>

            <!-- GALERÍA -->
            <section class="panel" id="tab-gallery" role="tabpanel" hidden>
              <div class="card" id="ecnGalleryCard">
                <div class="cardHead">
                  <h3 class="h3">Galería</h3>
                  <div class="mini">Administración de imágenes para galería.</div>
                </div>

                <div class="listHead">
                  <div class="pill">Items</div>
                  <div class="actions">
                    <button class="btn btn--ghost" id="refreshGalleryBtn" type="button">Actualizar</button>
                    <button class="btn btn--ghost" id="newGalleryBtn" type="button">Nuevo</button>
                  </div>
                </div>

                <div class="tableWrap">
                  <table class="table" aria-label="Tabla de galería">
                    <thead>
                      <tr>
                        <th>Preview</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Tags</th>
                        <th class="right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="galleryTbody"></tbody>
                  </table>
                </div>
              </div>

              <div class="modal" id="ecnGalleryModal" hidden aria-hidden="true" role="dialog" aria-label="Editar item de galería">
                <div class="modalBackdrop" data-close="true"></div>
                <div class="modalCard">
                  <div class="modalHead">
                    <div class="h3">Item de galería</div>
                    <button class="btn btn--ghost" id="ecnGalleryClose" type="button" aria-label="Cerrar">✕</button>
                  </div>

                  <form class="form" id="ecnGalleryForm" novalidate>
                    <input id="ecnPromoId" type="hidden" />
                    <input id="ecnGalName" type="hidden" />

                    <div class="formGrid">
                      <div class="field field--full">
                        <label class="label" for="ecnGalFile">Archivo</label>
                        <input class="input" id="ecnGalFile" type="file" accept="image/*,video/*" />
                      </div>

                      <div class="field">
                        <label class="label" for="ecnGalType">Tipo</label>
                        <select class="input" id="ecnGalType">
                          <option value="image">Imagen</option>
                          <option value="video">Video</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="ecnGalTags">Tags</label>
                        <input class="input" id="ecnGalTags" type="text" placeholder="ej: vinos, cata, andiamo" />
                        <div class="mini" id="sin-tags" hidden>Sin tags</div>
                      </div>

                      <div class="field field--full">
                        <label class="label">Preview</label>
                        <div class="preview" id="ecnGalPreview">
                          <img id="ecnGalPreviewImg" alt="Vista previa" />
                        </div>
                      </div>
                    </div>

                    <div class="formActions">
                      <button class="btn btn--primary" type="submit">GUARDAR</button>
                      <button class="btn btn--ghost" id="ecnGalReset" type="button">RESET</button>
                    </div>
                  </form>
                </div>
              </div>
            </section>

            <!-- PROMOS -->
            <section class="panel" id="tab-promos" role="tabpanel" hidden>
              <div class="card">
                <div class="cardHead">
                  <h3 class="h3">Promos</h3>
                  <div class="mini">Administración de promociones.</div>
                </div>

                <div class="listHead">
                  <div class="pill">Lista</div>
                  <div class="actions">
                    <button class="btn btn--ghost" id="refreshPromosBtn" type="button">Actualizar</button>
                    <button class="btn btn--ghost" id="newPromoBtn" type="button">Nueva</button>
                  </div>
                </div>

                <div class="tableWrap">
                  <table class="table" aria-label="Tabla de promociones">
                    <thead>
                      <tr>
                        <th>Título</th>
                        <th>Tipo</th>
                        <th>Prioridad</th>
                        <th>Activo</th>
                        <th class="right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="promosTbody"></tbody>
                  </table>
                </div>

                <div class="note" id="ecnNote"></div>
              </div>

              <div class="modal" id="ecnPromoModal" hidden aria-hidden="true" role="dialog" aria-label="Editar promoción">
                <div class="modalBackdrop" data-close="true"></div>
                <div class="modalCard">
                  <div class="modalHead">
                    <div class="h3">Promoción</div>
                    <button class="btn btn--ghost" id="ecnPromoClose" type="button" aria-label="Cerrar">✕</button>
                  </div>

                  <form class="form" id="ecnPromoForm" novalidate>
                    <input id="ecnPromoId" type="hidden" />

                    <div class="formGrid">
                      <div class="field field--full">
                        <label class="label" for="ecnTitle">Título</label>
                        <input class="input" id="ecnTitle" type="text" maxlength="120" />
                      </div>

                      <div class="field field--full">
                        <label class="label" for="ecnDesc">Descripción</label>
                        <textarea class="input textarea" id="ecnDesc" rows="4" maxlength="520"></textarea>
                        <div class="help">
                          <span id="ecnDescCount" class="muted">0/520</span>
                          <span class="muted">Opcional. Usá mensajes cortos.</span>
                        </div>
                      </div>

                      <div class="field">
                        <label class="label" for="ecnKind">Tipo</label>
                        <select class="input" id="ecnKind">
                          <option value="banner">Banner</option>
                          <option value="card">Card</option>
                          <option value="toast">Toast</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="ecnPriority">Prioridad</label>
                        <input class="input" id="ecnPriority" type="number" min="0" step="1" />
                      </div>

                      <div class="field">
                        <label class="label" for="ecnActive">Activo</label>
                        <select class="input" id="ecnActive">
                          <option value="true">Sí</option>
                          <option value="false">No</option>
                        </select>
                      </div>

                      <div class="field">
                        <label class="label" for="ecnBadge">Badge</label>
                        <input class="input" id="ecnBadge" type="text" maxlength="40" placeholder="ej: Nuevo" />
                      </div>

                      <div class="field field--full">
                        <label class="label" for="ecnMediaImg">Imagen (URL)</label>
                        <input class="input" id="ecnMediaImg" type="url" placeholder="Asigná desde Medios si aplica" />
                      </div>

                      <div class="field">
                        <label class="label" for="ecnCtaLabel">CTA (texto)</label>
                        <input class="input" id="ecnCtaLabel" type="text" maxlength="40" placeholder="Ver más" />
                      </div>

                      <div class="field">
                        <label class="label" for="ecnCtaHref">CTA (link)</label>
                        <input class="input" id="ecnCtaHref" type="url" placeholder="https://..." />
                      </div>

                      <div class="field field--full">
                        <label class="label">Preview</label>
                        <div class="preview" id="ecnPromoPreview"></div>
                      </div>
                    </div>

                    <div class="formActions">
                      <button class="btn btn--primary" type="submit">GUARDAR</button>
                      <button class="btn btn--ghost" id="ecnPromoReset" type="button">RESET</button>
                      <button class="btn btn--ghost" id="ecnDismiss" type="button" hidden>DISMISS</button>
                    </div>
                  </form>
                </div>
              </div>
            </section>

          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./js/supabaseClient.js"></script>
  <script src="./js/admin-auth.js"></script>

  <script src="./js/admin.js"></script>
  <script src="./js/admin-dates.js"></script>
  <script src="./js/admin-registrations.js"></script>
  <script src="./js/admin-media.js"></script>
  <script src="./js/admin-gallery.js"></script>
  <script src="./js/admin-promos.js"></script>

  <!-- Validador liviano de tamaño para mediaForm -->
  <script>
    (() => {
      const form = document.getElementById("mediaForm");
      const file = document.getElementById("mediaFile");
      if (!form || !file) return;

      const getMaxBytes = () => {
        const raw = form.getAttribute("data-max-mb");
        const mb = Number(raw || 25);
        const safe = Number.isFinite(mb) && mb > 0 ? mb : 25;
        return safe * 1024 * 1024;
      };

      const fmtMB = (bytes) => (bytes / (1024 * 1024)).toFixed(2) + " MB";

      const toast = (t, m) => {
        try { if (window.toast) return window.toast(t, m); } catch (_) {}
        try { if (window.APP && typeof APP.toast === "function") return APP.toast(t, m); } catch (_) {}
        alert(t + " — " + m);
      };

      file.addEventListener("change", () => {
        const f = file.files && file.files[0];
        if (!f) return;
        const max = getMaxBytes();
        if (f.size > max) toast("Archivo muy grande", `Máximo: ${fmtMB(max)}. Tu archivo: ${fmtMB(f.size)}.`);
      });

      form.addEventListener("submit", (e) => {
        const f = file.files && file.files[0];
        if (!f) return;
        const max = getMaxBytes();
        if (f.size > max) {
          e.preventDefault();
          e.stopPropagation();
          toast("No se puede subir", `El archivo excede ${fmtMB(max)}. Reducilo o exportalo más liviano.`);
        }
      }, true);
    })();
  </script>
</body>
</html>